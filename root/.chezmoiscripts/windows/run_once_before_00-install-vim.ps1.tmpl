{{ if eq .osId "windows"}}

$ErrorActionPreference = "Stop"

# Self-elevate the script to admin
if (-Not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] 'Administrator')) {
  if ([int](Get-CimInstance -Class Win32_OperatingSystem | Select-Object -ExpandProperty BuildNumber) -ge 6000) {
    $CommandLine = "-NoExit -File `"" + $MyInvocation.MyCommand.Path + "`" " + $MyInvocation.UnboundArguments
    Start-Process -Wait -FilePath PowerShell.exe -Verb Runas -ArgumentList $CommandLine
    Exit
  }
}

Write-Host "Ensuring Vim is installed..."

# Check if vim is already installed
if (Get-Command vim -ErrorAction SilentlyContinue) {
    Write-Host "Vim is already installed."
    vim --version | Select-Object -First 1
} else {
    Write-Host "Installing Vim using winget..."
    winget install --id vim.vim --accept-package-agreements --accept-source-agreements
    
    # Refresh environment path to make vim available
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
    
    Write-Host "Vim installation completed."
}

{{ end }}